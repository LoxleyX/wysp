name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libx11-dev libxtst-dev cmake build-essential

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      - name: Build whisper.cpp
        run: |
          git clone --depth 1 https://github.com/ggerganov/whisper.cpp
          cd whisper.cpp
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$HOME/.wysp \
            -DBUILD_SHARED_LIBS=ON \
            -DGGML_CPU=ON \
            -DWHISPER_BUILD_EXAMPLES=OFF \
            -DWHISPER_BUILD_TESTS=OFF
          cmake --build build -j$(nproc)
          cmake --install build

          # Debug: show installed files
          echo "=== Installed library files ==="
          ls -la $HOME/.wysp/lib/ 2>/dev/null || ls -la $HOME/.wysp/lib64/ 2>/dev/null || echo "No lib dir"

      - name: Build wysp
        run: |
          # Find where libraries were installed
          if [ -d "$HOME/.wysp/lib64" ]; then
            export WHISPER_LIB=$HOME/.wysp/lib64
          else
            export WHISPER_LIB=$HOME/.wysp/lib
          fi
          export WHISPER_INCLUDE=$HOME/.wysp/include

          echo "WHISPER_LIB=$WHISPER_LIB"
          echo "WHISPER_INCLUDE=$WHISPER_INCLUDE"
          ls -la $WHISPER_LIB/ || echo "Cannot list lib dir"

          zig build -Doptimize=ReleaseFast

      - name: Package Linux binary
        run: |
          mkdir -p wysp-linux-x86_64
          cp zig-out/bin/wysp wysp-linux-x86_64/
          cp README.md LICENSE wysp-linux-x86_64/
          cp logo.png logo-recording.png wysp-linux-x86_64/ 2>/dev/null || true
          tar -czvf wysp-linux-x86_64.tar.gz wysp-linux-x86_64

      - name: Create Debian package
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          PKG_DIR=wysp_${VERSION}_amd64

          mkdir -p ${PKG_DIR}/DEBIAN
          mkdir -p ${PKG_DIR}/usr/bin
          mkdir -p ${PKG_DIR}/usr/share/applications
          mkdir -p ${PKG_DIR}/usr/share/icons/hicolor/128x128/apps
          mkdir -p ${PKG_DIR}/usr/share/doc/wysp

          cp zig-out/bin/wysp ${PKG_DIR}/usr/bin/
          cp README.md LICENSE ${PKG_DIR}/usr/share/doc/wysp/
          cp logo.png ${PKG_DIR}/usr/share/icons/hicolor/128x128/apps/wysp.png 2>/dev/null || true

          cat > ${PKG_DIR}/DEBIAN/control << EOF
          Package: wysp
          Version: ${VERSION}
          Section: sound
          Priority: optional
          Architecture: amd64
          Depends: libgtk-3-0, libx11-6, libxtst6
          Maintainer: Wysp <wysp@example.com>
          Description: Local voice-to-text for any application
           Wysp is a completely local, privacy-respecting speech-to-text tool.
           Hold a hotkey, speak, release - your words appear at the cursor.
           100% offline. No cloud. No telemetry.
          EOF
          sed -i 's/^          //' ${PKG_DIR}/DEBIAN/control

          cat > ${PKG_DIR}/usr/share/applications/wysp.desktop << EOF
          [Desktop Entry]
          Name=Wysp
          Comment=Local voice-to-text for any application
          Exec=wysp
          Icon=wysp
          Terminal=false
          Type=Application
          Categories=Audio;Utility;
          Keywords=voice;speech;dictation;transcription;
          EOF
          sed -i 's/^          //' ${PKG_DIR}/usr/share/applications/wysp.desktop

          dpkg-deb --build ${PKG_DIR}
          mv ${PKG_DIR}.deb wysp_${VERSION}_amd64.deb

      - name: Create source package
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          git archive --format=tar.gz --prefix=wysp-${VERSION}/ HEAD > wysp-${VERSION}-source.tar.gz

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            wysp-linux-x86_64.tar.gz
            wysp_${{ steps.version.outputs.VERSION }}_amd64.deb
            wysp-${{ steps.version.outputs.VERSION }}-source.tar.gz
          generate_release_notes: true
