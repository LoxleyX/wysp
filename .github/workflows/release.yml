name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libx11-dev libxtst-dev cmake build-essential

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      - name: Build whisper.cpp with Zig (static)
        run: |
          git clone --depth 1 https://github.com/ggerganov/whisper.cpp
          cd whisper.cpp

          # Use Zig as C/C++ compiler for ABI compatibility with Zig's libc++
          export CC="zig cc"
          export CXX="zig c++"
          export AR="zig ar"
          export RANLIB="zig ranlib"

          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$HOME/.wysp \
            -DBUILD_SHARED_LIBS=OFF \
            -DGGML_CPU=ON \
            -DGGML_STATIC=ON \
            -DGGML_OPENMP=OFF \
            -DGGML_CCACHE=OFF \
            -DWHISPER_BUILD_EXAMPLES=OFF \
            -DWHISPER_BUILD_TESTS=OFF
          cmake --build build -j$(nproc)
          cmake --install build

      - name: Build wysp
        run: |
          if [ -d "$HOME/.wysp/lib64" ]; then
            export WHISPER_LIB=$HOME/.wysp/lib64
          else
            export WHISPER_LIB=$HOME/.wysp/lib
          fi
          export WHISPER_INCLUDE=$HOME/.wysp/include
          zig build -Doptimize=ReleaseFast

      - name: Package Linux binary
        run: |
          mkdir -p wysp-linux-x86_64
          cp zig-out/bin/wysp wysp-linux-x86_64/
          cp README.md LICENSE wysp-linux-x86_64/
          cp logo.png logo-recording.png wysp-linux-x86_64/ 2>/dev/null || true
          tar -czvf wysp-linux-x86_64.tar.gz wysp-linux-x86_64

      - name: Create Debian package
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          PKG_DIR=wysp_${VERSION}_amd64

          mkdir -p ${PKG_DIR}/DEBIAN
          mkdir -p ${PKG_DIR}/usr/bin
          mkdir -p ${PKG_DIR}/usr/share/applications
          mkdir -p ${PKG_DIR}/usr/share/icons/hicolor/128x128/apps
          mkdir -p ${PKG_DIR}/usr/share/wysp
          mkdir -p ${PKG_DIR}/usr/share/doc/wysp

          cp zig-out/bin/wysp ${PKG_DIR}/usr/bin/
          cp README.md LICENSE ${PKG_DIR}/usr/share/doc/wysp/
          cp logo.png ${PKG_DIR}/usr/share/icons/hicolor/128x128/apps/wysp.png 2>/dev/null || true
          cp logo.png logo-recording.png ${PKG_DIR}/usr/share/wysp/ 2>/dev/null || true

          cat > ${PKG_DIR}/DEBIAN/control << EOF
          Package: wysp
          Version: ${VERSION}
          Section: sound
          Priority: optional
          Architecture: amd64
          Depends: libgtk-3-0, libx11-6, libxtst6
          Maintainer: Wysp <contact@wysp.sh>
          Description: Local voice-to-text for any application
           Wysp is a completely local, privacy-respecting speech-to-text tool.
           Hold a hotkey, speak, release - your words appear at the cursor.
           100% offline. No cloud. No telemetry.
          EOF
          sed -i 's/^          //' ${PKG_DIR}/DEBIAN/control

          cat > ${PKG_DIR}/usr/share/applications/wysp.desktop << EOF
          [Desktop Entry]
          Name=Wysp
          Comment=Local voice-to-text for any application
          Exec=wysp
          Icon=wysp
          Terminal=false
          Type=Application
          Categories=Audio;Utility;
          Keywords=voice;speech;dictation;transcription;
          EOF
          sed -i 's/^          //' ${PKG_DIR}/usr/share/applications/wysp.desktop

          dpkg-deb --build ${PKG_DIR}

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            wysp-linux-x86_64.tar.gz
            wysp_${{ steps.version.outputs.VERSION }}_amd64.deb

  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      - name: Install Ninja
        shell: bash
        run: choco install ninja -y

      - name: Create Zig wrapper scripts
        shell: pwsh
        run: |
          # Create wrapper scripts that CMake can use
          $binDir = "$env:USERPROFILE\bin"
          New-Item -ItemType Directory -Force -Path $binDir

          # zig-cc.bat wrapper
          @"
          @echo off
          zig cc %*
          "@ | Out-File -FilePath "$binDir\zig-cc.bat" -Encoding ascii

          # zig-c++.bat wrapper
          @"
          @echo off
          zig c++ %*
          "@ | Out-File -FilePath "$binDir\zig-cxx.bat" -Encoding ascii

          # zig-ar.bat wrapper
          @"
          @echo off
          zig ar %*
          "@ | Out-File -FilePath "$binDir\zig-ar.bat" -Encoding ascii

          # zig-ranlib.bat wrapper (no-op, zig ar handles indexing)
          @"
          @echo off
          exit /b 0
          "@ | Out-File -FilePath "$binDir\zig-ranlib.bat" -Encoding ascii

          # Add to PATH for this session
          echo "$binDir" >> $env:GITHUB_PATH

      - name: Build whisper.cpp with Zig
        shell: pwsh
        run: |
          git clone --depth 1 https://github.com/ggerganov/whisper.cpp
          cd whisper.cpp

          $binDir = "$env:USERPROFILE\bin"

          # Use Zig as the compiler toolchain via wrapper scripts
          # This ensures whisper.cpp uses libc++ (same as Zig)
          # Disable ccache - it mangles the wrapper script quoting
          cmake -B build -G Ninja `
            -DCMAKE_C_COMPILER="$binDir\zig-cc.bat" `
            -DCMAKE_CXX_COMPILER="$binDir\zig-cxx.bat" `
            -DCMAKE_AR="$binDir\zig-ar.bat" `
            -DCMAKE_RANLIB="$binDir\zig-ranlib.bat" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_INSTALL_PREFIX="$env:USERPROFILE\.wysp" `
            -DBUILD_SHARED_LIBS=OFF `
            -DGGML_CPU=ON `
            -DGGML_STATIC=ON `
            -DGGML_OPENMP=OFF `
            -DGGML_CCACHE=OFF `
            -DWHISPER_BUILD_EXAMPLES=OFF `
            -DWHISPER_BUILD_TESTS=OFF

          cmake --build build --parallel
          cmake --install build

          # Fix library naming - Zig expects libXXX.a format
          cd $env:USERPROFILE\.wysp\lib
          if (Test-Path "ggml.a") { Rename-Item "ggml.a" "libggml.a" }
          if (Test-Path "ggml-base.a") { Rename-Item "ggml-base.a" "libggml-base.a" }
          if (Test-Path "ggml-cpu.a") { Rename-Item "ggml-cpu.a" "libggml-cpu.a" }

      - name: Build wysp
        shell: bash
        run: |
          export WHISPER_LIB=$USERPROFILE/.wysp/lib
          export WHISPER_INCLUDE=$USERPROFILE/.wysp/include

          # List what we have
          echo "=== Library directory ==="
          ls -la $WHISPER_LIB/ || true

          zig build -Doptimize=ReleaseFast -Dtarget=x86_64-windows-gnu

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: zig-out/bin/wysp.exe

  release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            linux-artifacts/wysp-linux-x86_64.tar.gz
            linux-artifacts/*.deb
            windows-artifacts/wysp.exe
          generate_release_notes: true
